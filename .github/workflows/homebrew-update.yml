name: Update Homebrew Formula

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # Use the release's tag_name (exact), normalize by removing leading v or V for VERSION.
            TAG="${{ github.event.release.tag_name }}"
            # Remove leading v or V for VERSION but keep TAG for URL
            VERSION="${TAG#v}"
            VERSION="${VERSION#V}"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          else
            VERSION=$(jq -r .version package.json)
            # For workflow_dispatch we set tag to v${VERSION} by default
            TAG="v${VERSION}"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Download release tarball
        run: |
          TAG=${{ steps.get_version.outputs.tag }}
          VERSION=${{ steps.get_version.outputs.version }}
          echo "Downloading tag=$TAG version=$VERSION"
          curl -sL https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz -o tm-cli-${VERSION}.tar.gz
          SHA256=$(shasum -a 256 tm-cli-${VERSION}.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Update Homebrew Formula
        run: |
          sed -i "s|url \".*\"|url \"https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.get_version.outputs.tag }}.tar.gz\"|" homebrew/tm-cli.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" homebrew/tm-cli.rb

      - name: Commit and push changes
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # VERSION is already available from GITHUB_ENV set in previous step
          BRANCH="homebrew-update-v${VERSION}"
          # Create and switch to new branch (or switch if it already exists)
          if git show-ref --verify --quiet refs/heads/${BRANCH}; then
            git switch ${BRANCH}
          else
            git switch -c ${BRANCH}
          fi
          git add homebrew/tm-cli.rb
          # Check if there are staged changes to avoid commit failure
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update homebrew formula to v${VERSION}"
          fi
          # Push and set upstream branch
          git push --set-upstream origin ${BRANCH}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Homebrew Tap PR (Optional)
        if: false
        run: |
          echo "To publish to Homebrew, create a PR to homebrew-core with the updated formula"
          echo "Or create your own tap repository at https://github.com/imkratos/homebrew-tap"
